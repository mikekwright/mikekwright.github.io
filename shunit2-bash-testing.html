
<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="http://mikewright.me/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="http://mikewright.me/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="http://mikewright.me/theme/font-awesome/css/font-awesome.min.css">


    <link href="http://mikewright.me/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Mike's Dev / Data Science Blog Atom">


    <link rel="shortcut icon" href="http://mikewright.me/images/favicon.jpg" type="image/x-icon">
    <link rel="icon" href="http://mikewright.me/images/favicon.jpg" type="image/x-icon">

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow" />


<meta name="author" content="Michael Wright" />
<meta name="description" content="So I have been working on the platform team at work for the last 2 years, and during this time we have had to not only write some code in Java and Ruby but also to write a number of bash scripts to help with management of systems. I'm ..." />
<meta name="keywords" content="testing, bash">
<meta property="og:site_name" content="Mike's Dev / Data Science Blog"/>
<meta property="og:title" content=""shUnit2 - Bash Testing""/>
<meta property="og:description" content="So I have been working on the platform team at work for the last 2 years, and during this time we have had to not only write some code in Java and Ruby but also to write a number of bash scripts to help with management of systems. I'm ..."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://mikewright.me/shunit2-bash-testing.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2013-10-31 22:03:00-06:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="http://mikewright.me/author/michael-wright.html">
<meta property="article:section" content="development"/>
<meta property="article:tag" content="testing"/>
<meta property="article:tag" content="bash"/>
<meta property="og:image" content="http://mikewright.me/images/avatar.jpg">

  <title>Mike's Dev / Data Science Blog &ndash; "shUnit2 - Bash Testing"</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://mikewright.me">
        <img src="http://mikewright.me/images/avatar.jpg" alt="Love 2 Code" title="Love 2 Code">
      </a>
      <h1><a href="http://mikewright.me">Love 2 Code</a></h1>


      <nav>
        <ul class="list">
          <li><a href="http://mikewright.me/pages/about.html#about">About</a></li>
          <li><a href="http://mikewright.me/pages/contact.html#contact">Contact</a></li>
          <li><a href="http://mikewright.me/pages/experience.html#experience">Experience</a></li>

        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-linkedin" href="https://www.linkedin.com/in/mikekwright" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-github" href="https://github.com/mikekwright" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-twitter" href="https://twitter.com/mikekwright" target="_blank"><i class="fa fa-twitter"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://mikewright.me">    Home
</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="http://mikewright.me/feeds/all.atom.xml">    Atom
</a>

    </nav>

<article class="single">
  <header>
    <h1 id="shunit2-bash-testing">"shUnit2 - Bash Testing"</h1>
    <p>
          Posted on Thu 31 October 2013 in <a href="http://mikewright.me/category/development.html">development</a>


    </p>
  </header>
  <div>
    <p>So I have been working on the platform team at work for the last 2 years, and during this time
we have had to not only write some code in Java and Ruby but also to write a number of bash
scripts to help with management of systems.  I'm a huge proponent of unit testing and especially
of TDD.  </p>
<p>Since we have had a goal recently to make sure we are meeting minimum code coverage
requirements on all of our tools I have looked into what it would take to unit test our bash
scripts.  Luckily there is an engineer who is already doing some bash testing on another 
team and he pointed me towards shUnit2 and some example projects they are using it with inhouse.  </p>
<p>In this post I am going to cover the areas of shUnit2 that I have found to be the most useful, 
and how the process of mocking and other interactions could be handled.  </p>
<!-- more -->

<h2>shUnit2</h2>
<p><a href="https://code.google.com/p/shunit2/">shUnit2</a> is an xunit style testing framework made to 
work with Bash scripts.  It has a very simple setup process on my systems (especially 
debian-based systems).   </p>
<h3>Installation</h3>
<p>To install shUnit2 on a debian based system you only need to run the below command. </p>
<div class="highlight"><pre><span></span>    apt-get install shunit2
</pre></div>


<p>If everything is setup correctly you should see output similiar to that below. </p>
<div class="highlight"><pre><span></span>    $ shunit2

    Ran 0 tests.

    OK
</pre></div>


<p>You can also manually install it by downloading the latest build from 
<a href="https://shunit2.googlecode.com/files/shunit2-2.1.6.tgz">code.google.com</a>. This is actually
a nice thing to pull down as it contains some useful examples for shUnit2. After pulling it 
you will need to add it to your path for usage. </p>
<div class="highlight"><pre><span></span><span class="x">    wget https://shunit2.googlecode.com/files/shunit2-2.1.6.tgz</span>
<span class="x">    tar -xvf shunit2-2.1.6.tgz</span>
<span class="x">    PATH=</span><span class="p">$</span><span class="nv">DIRSTACK</span><span class="x">/shunit2-2.1.6/bin:</span><span class="p">$</span><span class="nv">PATH</span><span class="x"></span>
<span class="x">    shunit2</span>
</pre></div>


<h3>First Tests</h3>
<p>The easiest way to start learning a framework is often to use the framework, so lets quickly
jump in using an example test.  </p>
<p>Open up your favorite text editor and enter the code defined below.  </p>
<div class="gist">
    <script src='https://gist.github.com/7325445.js?file=my-first-test.sh'></script>
    <noscript>
        <pre><code>#!/bin/bash
#
# Description: This is a sample test using shunit2
#

testMyComparison() 
{
  assertTrue "This is the message if it fails" "[ 1 -eq 1 ]"
}

. shunit2
</code></pre>
    </noscript>
</div>
<p>Now to run this test you will need to make a few changes to the file, which for this case
lets have the file called <code>my-first-test.sh</code></p>
<div class="highlight"><pre><span></span>    $ chmod +x my-first-test.sh
    $ ./my-first-test.sh

    testMyComparison

    Ran 1 tests.

    OK
</pre></div>


<p>If this doesn't work, check a couple of things that might be the cause. </p>
<ul>
<li>shunit2 should be in the path</li>
<li>function name starts with lowercase 'test'</li>
<li>assertTrue comparison has correct spacing and quotes - <code>"[ 1 -eq 1 ]"</code></li>
</ul>
<h3>Assertions</h3>
<p>One of the most important part of tests is making sure that the test is descriptive
in what it is trying to accomplish. To help achieve this these xUnit frameworks will 
often include a number of different assertions that can help to make the code more
readable.    </p>
<p>This is the list of current assertions as of version 2.1.6  </p>
<ul>
<li>assertEquals [message] expected actual</li>
<li>assertSame [message] expected actual</li>
<li>assertNotEquals [message] expected actual</li>
<li>assertNotSame [message] expected actual</li>
<li>assertNull [message] value</li>
<li>assertNotNull [message] value</li>
<li>assertTrue [message] condition</li>
<li>assertFalse [message] condition</li>
</ul>
<p>There are a couple of things to be aware of when using these assertions, especially the 
assertNull and assertNotNull calls.  They are used to compare a null in bash which is a 
zero length string.  </p>
<h3>Failures</h3>
<p>Next to assertions you also have failures that you can place in your code to automatically
trigger the test to fail and execution to stop.  This is a list of the different failures
that are supported in shUnit2.   </p>
<p><em>Note: failures are not for value comparisons, if you need this functionality use assertions</em>  </p>
<ul>
<li>fail [message]</li>
<li>failNotEquals [message] unexpected actual</li>
<li>failSame [message] expected actual</li>
<li>failNotSame [message] unexpected actual</li>
</ul>
<h2>Code Dependencies</h2>
<p>One of the common situations that you will run across with unit testing is making sure that
your code is testing the smallest piece possible, which can help you quickly and easily 
find bugs that could show up, and give you better confidence with refactoring.    </p>
<p>In most other languages this is accomplished using mocking frameworks (java and mockito, 
.net and rhinomocks). In bash I have not yet found a framework that successfully mocks 
calls that could be made from the bash scripts, so instead the process that I recommend 
is accomplished using PATH manipulation and running calls.  </p>
<p>Lets start with a simple script that is used to pull down a sample configuration using 
wget and then executes the configuration.  <code>configRetriever.sh</code></p>
<div class="gist">
    <script src='https://gist.github.com/7325511.js?file=configRetriever.sh'></script>
    <noscript>
        <pre><code> #!/bin/bash
if [ -z "$1" ]
then
  echo "Missing required command line url"
  exit 1
fi

wget http://s3.amazon.com/work/sharedconfig.txt
if [ ! $? -eq  0 ]
then
  echo "Failed to get the file from the web"
  exit 2
fi

echo "Success"
</code></pre>
    </noscript>
</div>
<p>Now that we have our test file, there are two more files that we need, the tests and 
also a mock of wget.  So lets first start with the mock. <code>wget</code></p>
<p>[gist:id=7325539,file=wget] </p>
<p>And finally the actual tests. <code>configTests.sh</code>  </p>
<div class="gist">
    <script src='https://gist.github.com/7325587.js?file=configTests.sh'></script>
    <noscript>
        <pre><code>#!/bin/bash

setUp()
{
  originalPath=$PATH
  PATH=$PWD:$PATH
}

tearDown()
{
  PATH=$originalPath
  export TEST_WGET_FAILURE=
}

testFailsWhenArgumentNotSupplied()
{
  ./configRetriever.sh > /dev/null
  returnCode=$?
  assertEquals "Script should fail when no argument" 1 $returnCode
}

testFailsWhenwgetFails()
{
  export TEST_WGET_FAILURE=1
  ./configRetriever.sh "testUrl" > /dev/null
  returnCode=$?
  assertEquals "Script should fail when wget fails" 2 $returnCode
}

testSuccessAllAround()
{
  response=$(./configRetriever.sh "testUrl")
  echo "$response" | grep -qE "Script was a success" 
  returnCode=$?
  assertEquals "Script was not successful" 0 $returnCode
}

. shunit2</code></pre>
    </noscript>
</div>
<p>A couple of things to point out from here, I am adjusting the path before each test and I am
restoring it after a test using the <code>setUp()</code> and <code>tearDown()</code>.  It is important to make 
sure that you are forcing a clean slate for each test, so you don't get false negatives (or
positives for that matter).  </p>
<p>The next important thing to see is how to hide or handle output from the running script, 
you should do this otherwise you might find it hard to find the alerts from test outputs
that are run.  </p>
<h2>Conclusion</h2>
<p>So after getting my feet a little wet with shUnit2 and using path manipulation to handle
script internal calls, I have to say that I think bash unit testing is much easier 
than I had originally figured and am excited to move forward with testing my scripts. </p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="http://mikewright.me/tag/testing.html">testing</a>
      <a href="http://mikewright.me/tag/bash.html">bash</a>
    </p>
  </div>



</article>

    <footer>
<p>&copy; Michael Wright 2016</p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>





<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Mike's Dev / Data Science Blog ",
  "url" : "http://mikewright.me",
  "image": "http://mikewright.me/images/avatar.jpg",
  "description": "Simple blog created for discussing different topics around development and data science"
}
</script>
</body>
</html>